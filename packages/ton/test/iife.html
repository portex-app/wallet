<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portex TON é’±åŒ… IIFE æµ‹è¯•</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      .section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background-color: #fafafa;
      }

      .button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .status {
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
        font-weight: bold;
      }

      .status.connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
      }

      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
      }

      input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin: 5px 0;
        box-sizing: border-box;
      }

      label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
        color: #555;
      }

      .code-block {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        overflow-x: auto;
        margin: 10px 0;
        word-wrap: break-word;
        white-space: pre-wrap;
      }

      .wallet-info {
        margin: 10px 0;
        padding: 10px;
        background-color: #e8f4fd;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸš€ Portex TON é’±åŒ… IIFE æµ‹è¯•é¡µé¢</h1>

      <div class="info">
        <strong>è¯´æ˜ï¼š</strong> è¿™ä¸ªé¡µé¢æ¼”ç¤ºäº†å¦‚ä½•åœ¨HTMLä¸­ä½¿ç”¨Portex TONé’±åŒ…SDKçš„IIFEç‰ˆæœ¬ã€‚è¯·ç¡®ä¿ä½ å·²ç»æ„å»ºäº†é¡¹ç›®å¹¶ä¸”distæ–‡ä»¶å­˜åœ¨ã€‚
      </div>

      <div class="section">
        <h3>ğŸ”Œ é’±åŒ…è¿æ¥</h3>
        <div id="walletStatus" class="status disconnected">æœªè¿æ¥</div>
        <div id="walletInfo" class="wallet-info">é’±åŒ…åœ°å€: -</div>
        <div class="form-group">
          <label for="manifesté…ç½®">manifesté…ç½®</label>
          <input type="text" id="manifestUrl" placeholder="manifesté…ç½®" />
        </div>
        <button class="button" id="connectBtn">è¿æ¥é’±åŒ…</button>
        <button class="button" id="disconnectBtn" disabled>æ–­å¼€è¿æ¥</button>
        <button class="button" id="getAccountBtn">è·å–è´¦æˆ·ä¿¡æ¯</button>
      </div>

      <div class="section">
        <h3>ğŸ’¸ å‘é€äº¤æ˜“</h3>
        <div class="form-group">
          <label for="toAddress">æ¥æ”¶åœ°å€:</label>
          <input type="text" id="toAddress" placeholder="EQD..." />
        </div>
        <div class="form-group">
          <label for="amount">é‡‘é¢ (TON):</label>
          <input type="text" id="amount" placeholder="0.01" value="0.01" />
        </div>
        <div class="form-group">
          <label for="payload">å¤‡æ³¨ (å¯é€‰):</label>
          <input type="text" id="payload" placeholder="Hello TON!" />
        </div>
        <button class="button" id="sendBtn" disabled>å‘é€äº¤æ˜“</button>
      </div>

      <div class="section">
        <h2>JETTONè½¬è´¦</h2>
        <div class="form-group">
          <label for="jettonMasterAddress">jetton token åˆçº¦åœ°å€</label>
          <input type="text" id="jettonMasterAddress" placeholder="è¾“å…¥jetton token åˆçº¦åœ°å€" />
        </div>
        <div class="form-group">
          <label for="jettonAmount">è½¬è´¦æ•°é‡</label>
          <input type="number" id="jettonAmount" step="1" min="0" placeholder="è¾“å…¥è½¬è´¦æ•°é‡" />
        </div>
        <div class="form-group">
          <label for="jettonTo">æ¥æ”¶åœ°å€</label>
          <input type="text" id="jettonTo" placeholder="è¾“å…¥æ¥æ”¶åœ°å€" />
        </div>
        <div class="form-group">
          <label for="jettonMessage">æ¶ˆæ¯å†…å®¹ï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" id="jettonMessage" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹" />
        </div>
        <button class="button" id="sendJetton" disabled>å‘é€JETTON</button>
        <div id="jettonResult" class="result"></div>
      </div>

      <div class="section">
        <h3>ğŸ“‹ æ—¥å¿—</h3>
        <div id="logs" class="code-block"></div>
        <button class="button" id="clearLogsBtn">æ¸…ç©ºæ—¥å¿—</button>
      </div>
    </div>
    <!-- å¼•å…¥ IIFE æ ¼å¼çš„åº“ -->
    <script src="../dist/index.iife.js"></script>
    <script>
      let wallet = null;

      // TON Connect manifesté…ç½®
      document.getElementById('manifestUrl').value = 'https://i.gameva.ai/assets/gameva/ton-mainfest.json';
      document.getElementById('jettonTo').value = '0QA8f92-GENWXFA34cLdTqVKnS-yUf3J3VhVSTMzWJxfOAWh';
      document.getElementById('jettonMasterAddress').value = 'kQBgoZ8ewPuqOsnPz83RpJaekmr2raYdLHOvz03U9Kglu7Nx';

      function log(message, type = 'info') {
        const logs = document.getElementById('logs');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${message}`;

        const logDiv = document.createElement('div');
        logDiv.textContent = logEntry;
        logs.appendChild(logDiv);

        logs.scrollTop = logs.scrollHeight;

        console.log(message);

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (type === 'error') {
          showError(message);
        }
      }

      function clearLogs() {
        document.getElementById('logs').innerHTML = '';
      }

      function showError(message) {
        // åˆ›å»ºé”™è¯¯æç¤ºå…ƒç´ 
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = `é”™è¯¯: ${message}`;

        // æ’å…¥åˆ°ç¬¬ä¸€ä¸ªsectionä¹‹å‰
        const container = document.querySelector('.container');
        const firstSection = container.querySelector('.section');
        container.insertBefore(errorDiv, firstSection);

        // 3ç§’åè‡ªåŠ¨åˆ é™¤
        setTimeout(() => {
          if (errorDiv.parentNode) {
            errorDiv.parentNode.removeChild(errorDiv);
          }
        }, 5000);
      }

      function initWallet() {
        const manifestUrl = document.getElementById('manifestUrl').value;
        if (!manifestUrl) {
          throw new Error('manifesté…ç½®æ–‡ä»¶ä¸èƒ½ä¸ºç©º');
        }
        wallet = PortexTON.Wallet.getInstance(manifestUrl);
        wallet.addStatusChangeListener((status, account) => {
          updateWalletStatus(status, account);
        });
        log('é’±åŒ…åˆå§‹åŒ–å®Œæˆ');
      }

      function updateWalletStatus(status, account) {
        const statusEl = document.getElementById('walletStatus');
        const infoEl = document.getElementById('walletInfo');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendBtn = document.getElementById('sendBtn');
        const sendJetton = document.getElementById('sendJetton');

        statusEl.textContent = status === 'connected' ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
        statusEl.className = `status ${status}`;

        if (account) {
          infoEl.textContent = `é’±åŒ…åœ°å€: ${account.address}`;
          infoEl.style.display = 'block';
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          sendBtn.disabled = false;
          sendJetton.disabled = false;
        } else {
          infoEl.textContent = 'é’±åŒ…åœ°å€: -';
          infoEl.style.display = 'none';
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          sendBtn.disabled = true;
          sendJetton.disabled = true;
        }
      }

      async function connectWallet() {
        try {
          log('è¿æ¥é’±åŒ…...');

          if (!wallet) {
            throw new Error('é’±åŒ…å®ä¾‹æœªåˆå§‹åŒ–');
          }

          await wallet.connect();
        } catch (error) {
          log(`è¿æ¥é’±åŒ…å¤±è´¥: ${error.message}`, 'error');
        }
      }

      async function disconnectWallet() {
        try {
          log('æ–­å¼€é’±åŒ…è¿æ¥...');

          if (!wallet) {
            throw new Error('é’±åŒ…å®ä¾‹æœªåˆå§‹åŒ–');
          }

          await wallet.disconnect();
          log('é’±åŒ…å·²æ–­å¼€è¿æ¥');
        } catch (error) {
          log(`æ–­å¼€è¿æ¥å¤±è´¥: ${error.message}`, 'error');
        }
      }

      async function getAccountInfo() {
        try {
          if (!wallet) {
            throw new Error('é’±åŒ…å®ä¾‹æœªåˆå§‹åŒ–');
          }

          log('è·å–è´¦æˆ·ä¿¡æ¯...');
          log(`è´¦æˆ·åœ°å€: ${wallet.account?.address || 'æœªè¿æ¥'}`);
          log(`é’±åŒ…çŠ¶æ€: ${wallet.status}`);
        } catch (error) {
          log(`è·å–è´¦æˆ·ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
        }
      }

      async function sendTransaction() {
        try {
          const toAddress = document.getElementById('toAddress').value;
          const amount = parseFloat(document.getElementById('amount').value);
          const payload = document.getElementById('payload').value;

          if (!amount || isNaN(amount) || amount <= 0) {
            throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢');
          }

          log('å‘é€äº¤æ˜“...');
          log(`æ¥æ”¶åœ°å€: ${toAddress}`);
          log(`é‡‘é¢: ${amount} TON`);
          log(`å¤‡æ³¨: ${payload || 'æ— '}`);

          const result = await wallet.sendTransaction(toAddress, amount, payload);
          log(`äº¤æ˜“å·²å‘é€ï¼Œç»“æœ: ${JSON.stringify(result)}`);
        } catch (error) {
          log(`å‘é€äº¤æ˜“å¤±è´¥: ${error.message}`, 'error');
        }
      }

      // ç»‘å®šäº‹ä»¶å¤„ç†å‡½æ•°
      document.getElementById('connectBtn').addEventListener('click', connectWallet);
      document.getElementById('disconnectBtn').addEventListener('click', disconnectWallet);
      document.getElementById('getAccountBtn').addEventListener('click', getAccountInfo);
      document.getElementById('sendBtn').addEventListener('click', sendTransaction);
      document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.addEventListener('load', () => {
        log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
        initWallet();
      });

      // è°ƒè¯•ä¿¡æ¯
      log('HTMLé¡µé¢è„šæœ¬å·²åŠ è½½');
      log(`å½“å‰æ—¶é—´: ${new Date().toLocaleString()}`);

      document.getElementById('sendJetton').addEventListener('click', async () => {
        const amount = document.getElementById('jettonAmount').value;
        const to = document.getElementById('jettonTo').value;
        const message = document.getElementById('jettonMessage').value;
        const jettonMasterAddress = document.getElementById('jettonMasterAddress').value;
        try {
          const txHash = await wallet.sendJettonTransaction(jettonMasterAddress, to, amount, message);
          document.getElementById('jettonResult').textContent = `äº¤æ˜“æˆåŠŸï¼Œå“ˆå¸Œ: ${txHash}`;
        } catch (error) {
          document.getElementById('jettonResult').textContent = `äº¤æ˜“å¤±è´¥: ${error.message}`;
        }
      });
    </script>
  </body>
</html>
